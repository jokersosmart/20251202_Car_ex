# 功能規格：SSD 控制器電源管理安全功能

**Feature ID**: 001-Power-Management-Safety  
**Feature Name**: SSD Controller Power Management Safety Feature  
**Version**: 1.0.0  
**Date**: 2025-12-02  
**ASIL Level**: ASIL-B  
**Status**: SPECIFICATION (假設需求，基於 SEooC 框架)

---

## 1. 功能概述

### 1.1 目的

定義 PCIe Gen5 SSD 控制器電源管理安全功能的完整需求，確保在電源故障、時鐘丟失或記憶體損毀時，系統能自動進入安全狀態，保護快閃記憶體資料完整性。

### 1.2 應用場景 (SEooC 假設)

```
使用情景: PCIe Gen5 NVMe SSD 嵌入式在車載信息娛樂系統 (IVI)
└─ 環境: 12V 車載電氣環境
   ├─ 瞬間掉電事件 (cold crank: 50ms 左右)
   ├─ 時鐘故障 (PLL 失鎖)
   └─ 記憶體故障 (單位元翻轉 SBE)

安全目標: 防止以上故障導致快閃記憶體資料遺失或系統當機
```

### 1.3 關鍵約束

- **ASIL 等級**: ASIL-B (根據 ISO 26262-1:2018)
- **目標系統**: PCIe Gen5 SSD ASIC (ARM Cortex-M4 + FPGA fabric)
- **工作溫度**: 0-85°C (automotive grade)
- **工作電壓**: 3.3V ±5% (3.135V - 3.465V nominal)

---

## 2. 安全目標 (SG) - 基於 Q1 澄清決策

### SG-001: 電源故障保護

**安全目標文本**:  
系統應防止由於供電中斷或電壓低於正常範圍導致的快閃記憶體資料遺失。當檢測到電源故障時，系統必須進入預定義的安全狀態，停止所有寫操作並隔離記憶體。

**ASIL 等級**: ASIL-B  
**失效後果**: S3 (可恢復) + E3 (經常發生) = ASIL-B  

---

### SG-002: 時鐘故障保護

**安全目標文本**:  
系統應防止由於時鐘丟失或 PLL 失鎖導致的控制流混亂。當檢測到時鐘異常時，系統必須立即進入安全狀態，防止非同步存取記憶體。

**ASIL 等級**: ASIL-B  
**失效後果**: S2 (嚴重) + E2 (可能) = ASIL-B  

---

### SG-003: 記憶體故障保護

**安全目標文本**:  
系統應檢測和糾正單位元記憶體故障 (SBE)，防止累積故障導致資料損毀。當檢測到不可糾正的多位元故障 (MBE) 時，系統應停止該記憶體區塊的存取。

**ASIL 等級**: ASIL-B  
**失效後果**: S3 (可恢復) + E3 (經常發生) = ASIL-B  

---

## 3. 功能安全需求 (FSR) - 基於 Q2/Q3/Q4 澄清決策

### FSR-001: VDD 低壓檢測和響應

**需求編號**: FSR-001  
**需求標題**: VDD 低壓檢測和安全狀態進入

**需求文本**:  
系統必須持續監控輸入電壓 VDD。當 VDD 低於 2.7V (±50mV) 時，系統必須在 10ms 內進入安全狀態。安全狀態包括：停止記憶體寫操作、隔離數據匯流排、設置故障標誌。

**ASIL 等級**: ASIL-B  
**來源**: SG-001 (電源故障保護)  

**邊界條件**:
- 正常工作電壓: 3.3V ± 5% (3.135V - 3.465V)
- 故障檢測電壓: 2.7V ±50mV
- 反應時間: 10ms ±2ms
- 工作溫度: 0-85°C

**驗證方法**: 測試  
**驗收標準**:
- 在 2.65V 時開始檢測 VDD 低
- 在 2.75V 時停止誤報
- 進入安全狀態延遲 ≤ 10ms
- 100 次測試全部通過

---

### FSR-002: 時鐘丟失檢測和響應

**需求編號**: FSR-002  
**需求標題**: 時鐘監控和故障檢測

**需求文本**:  
系統必須監控主時鐘信號。當主時鐘停止超過 1μs 時，系統必須在 5ms 內進入安全狀態。失效時鐘可能導致非同步記憶體存取，必須完全隔離。

**ASIL 等級**: ASIL-B  
**來源**: SG-002 (時鐘故障保護)  

**邊界條件**:
- 監控時鐘頻率: 400 MHz ± 1%
- 最大允許停止時間: 1μs
- 故障檢測延遲: < 100ns
- 安全狀態進入延遲: < 5ms

**驗證方法**: 測試 + 分析  
**驗收標準**:
- 注入時鐘停止 > 1μs，驗證檢測
- 時鐘恢復後可恢復正常操作
- 無虛報（時鐘暫停 < 1μs 不觸發）

---

### FSR-003: 記憶體 ECC 故障檢測和修正

**需求編號**: FSR-003  
**需求標題**: 記憶體故障檢測和錯誤糾正

**需求文本**:  
系統必須為主記憶體 (2MB SRAM) 實施 ECC 保護。軟體必須檢測和糾正單位元錯誤 (SBE)，並在檢測到不可糾正的多位元錯誤 (MBE) 時進入安全狀態。故障檢測覆蓋率必須 > 90%。

**實現註解**: ECC 故障檢測由硬體 ECC 檢查器內建提供，自動檢測 SBE/MBE 並生成中斷信號。軟體層透過 TSR-002 (ISR) 檢測並處理 ECC 故障事件，因此 FSR-003 無直接的技術安全需求 (TSR) 定義。

**ASIL 等級**: ASIL-B  
**來源**: SG-003 (記憶體故障保護)  

**邊界條件**:
- 保護範圍: 2MB 主 SRAM
- 故障檢測延遲: < 100ns (硬體 ECC 生成)
- 故障診斷覆蓋率: > 90%
- 支援的故障: SBE 自動糾正，MBE 上報

**驗證方法**: 測試 + 分析  
**驗收標準**:
- SBE 故障率: > 99% 檢測和糾正
- MBE 故障率: 100% 檢測，進入安全狀態
- 無虛報 (正常數據不觸發錯誤標誌)

---

### FSR-004: 故障狀態管理和恢復

**需求編號**: FSR-004  
**需求標題**: 故障狀態機和恢復管理

**需求文本**:  
系統軟體必須實現故障狀態機，聚合來自多個故障源（VDD、CLK、MEM）的故障事件。當任意故障被確認時，系統進入 "故障" 狀態。故障狀態下，系統將等待外部恢復信號，然後執行重新初始化流程。

**ASIL 等級**: ASIL-B  
**來源**: SG-001, SG-002, SG-003 (所有安全目標)  

**狀態定義**:
```
[INIT] → [NORMAL] → [FAULT] → [SAFE_STATE] → [RECOVERY] → [INIT]

NORMAL: 無故障檢測，系統正常運作
FAULT: 檢測到故障，等待安全狀態確認
SAFE_STATE: 硬體/軟體安全狀態已進入
RECOVERY: 故障排除，恢復流程進行中
```

**外部恢復信號定義**:
當系統處於 SAFE_STATE 時，等待外部恢復信號以進入 RECOVERY：
- **信號來源**: 主機 PCIe 控制平面 (例如：PCIe hot reset 信號)
- **信號機制**: 確認故障源已清除 (fault_flags 均不作置)
- **超時設定**: 100ms 超時不受恢復信號時，系統保持 SAFE_STATE

**驗收標準**:
- 狀態轉遷覆蓋率 100%
- 故障聚合邏輯正確性 100% (所有故障組合測試)
- 無死鎖狀態

---

## 4. 系統安全需求 (SysReq)

### SysReq-001: 硬體/軟體分配 - 基於 Q2 決策

**需求編號**: SysReq-001  
**需求標題**: 硬體故障檢測 + 軟體故障管理架構

**需求文本**:  
系統採用雙層故障檢測架構：
1. **硬體層** (< 1μs 檢測延遲)
   - VDD 監控電路: 類比比較器持續監控
   - 時鐘監控電路: 數位看門狗計時器
   - 記憶體 ECC: 硬體 ECC 生成和檢測
   - 安全預設狀態: 硬體自動進入故障安全狀態

2. **軟體層** (5-100ms 管理延遲)
   - ISR 驅動故障響應
   - 故障狀態機管理
   - 恢復流程控制
   - 故障日誌記錄

**分配決策**:
- 硬體責任: 故障檢測 (< 1μs) + 安全預設狀態
- 軟體責任: 故障確認 + 管理 + 恢復 (< 5ms 進入安全狀態)
- 介面: ISR 驅動的異步握手協議

**驗收標準**:
- 硬體檢測延遲: < 1μs (測量 ±10%)
- 軟體反應延遲: < 5ms (從 ISR entry 到安全狀態確認)
- 總響應時間: < 10ms (硬體 + 軟體)

---

### SysReq-002: 故障源隔離 - 基於 Q4 決策

**需求編號**: SysReq-002  
**需求標題**: 故障源獨立性驗證

**需求文本**:  
硬體故障和軟體故障必須被設計為相互獨立的（無共同根本原因）。這允許根據 ISO 26262-3 Part 8 的獨立故障假設，將 ASIL-B 系統降級為 ASIL-A 實現。

**獨立性分析**:
```
硬體故障源:
├─ VDD 監控 (類比電路): 比較器失效、RC 漂移
├─ 時鐘監控 (數位電路): 計時器邏輯錯誤
└─ 記憶體 ECC (混合): 傳感器故障

軟體故障源:
├─ ISR 邏輯錯誤: 編碼錯誤、條件判斷錯誤
├─ 狀態機錯誤: 狀態轉遷錯誤
└─ 恢復邏輯錯誤: 超時判斷錯誤

共同根本原因分析: 無
→ 獨立故障假設成立
```

**故障優先級規則** (當多個故障同時發生時):

| 優先級 | 故障源 | 威脅類型 | ISR 響應優先度 |
|--------|--------|----------|------------------|
| **P1 (最高)** | VDD 低於 2.7V | 系統級 - 供電丟失 | 首先檢測並設置 pwr_fault |
| **P2 (中)** | 時鐘停止 > 1μs | 同步性 - 非同步操作 | 其次檢測並設置 clk_fault |
| **P3 (低)** | 記憶體 MBE | 資料完整性威脅 | 最後檢測並設置 mem_fault |

**聚合策略**: 故障狀態機根據 fault_flags 中設置的最高優先級位，決定系統進入安全狀態的方式。所有聚合邏輯必須原子性執行，防止競爭條件。

**驗收標準**:
- FMEA 分析覆蓋 100% 硬體和軟體故障模式
- 共同根本原因計數: 0
- 診斷覆蓋率: > 90%

---

## 5. 技術安全需求 (TSR)

### TSR-001: 硬體 VDD 監控電路

**需求編號**: TSR-001  
**需求標題**: VDD 監控電路實現規格

**需求文本**:  
VDD 監控電路必須使用低噪聲類比比較器監控供電電壓。當 VDD 低於 2.65V (±50mV) 時，比較器必須在 < 1μs 內產生 FAULT 信號的高脈衝。FAULT 信號必須保持高電平，直到 VDD 恢復至正常範圍。

**ASIL 等級**: ASIL-B  
**分類**: 故障檢測  

**實現邊界**:
- 硬體: 比較器 + RC 濾波 + 輸出緩衝
- 軟體: 無 (純硬體實現)
- 介面: FAULT 信號輸出 (3.3V TTL)

**驗收標準**:
1. VDD 在 2.65V - 2.75V 間逐步變化，測量 FAULT 延遲
2. 延遲必須 < 1μs，容差 ±10%
3. FAULT 脈衝寬度 > 1μs
4. 100 次測試全部通過
5. 無虛報 (VDD 正常時 FAULT 保持低)

**驗證方法**: 測試 (UVM 模擬 + 後矽驗證)

---

### TSR-002: 軟體故障檢測 ISR

**需求編號**: TSR-002  
**需求標題**: 故障檢測中斷服務程式

**需求文本**:  
軟體故障檢測 ISR 必須在 FAULT 信號上升沿觸發。ISR 必須在 < 5μs 內識別故障源，設置故障標誌，並觸發故障狀態機進入故障狀態。ISR 必須是可重入的（支援多個故障源同時觸發）。

**ASIL 等級**: ASIL-B  
**分類**: 故障檢測 + 控制  

**實現邊界**:
- 硬體: 中斷線路 (FAULT → IRQ)
- 軟體: ISR 例程 + fault_flags 設置
- 介面: ISR 觸發協議

**驗收標準**:
1. ISR 執行時間 < 5μs (測量從 FAULT 到 ISR 出口)
2. 故障標誌正確設置 (100% 正確性)
3. 可重入性驗證 (同時多個 FAULT 信號)
4. 無數據競爭 (volatile 聲明、原子操作)

**驗證方法**: 測試 (單元測試 + 整合測試)

---

### TSR-003: 軟體故障聚合和狀態機

**需求編號**: TSR-003  
**需求標題**: 故障聚合和狀態機管理

**需求文本**:  
軟體必須實現故障聚合邏輯，聚集來自多個故障源（VDD、CLK、MEM）的故障事件。聚合邏輯必須驅動安全狀態機從正常狀態轉遷至故障狀態。狀態機必須支援故障清除和恢復流程。

**ASIL 等級**: ASIL-B  
**分類**: 控制 + 故障安全  

**狀態轉遷規則**:
```
INIT:
  ├─ pwr_fault 設置 → FAULT
  ├─ clk_fault 設置 → FAULT
  ├─ mem_fault 設置 → FAULT
  └─ 無故障 → NORMAL

NORMAL:
  ├─ 任意 fault_flag 設置 → FAULT
  └─ 無故障 → NORMAL

FAULT:
  ├─ 硬體安全狀態已確認 → SAFE_STATE
  └─ 故障仍存在 → FAULT

SAFE_STATE:
  ├─ 故障清除信號 → RECOVERY
  └─ 故障仍存在 → SAFE_STATE

RECOVERY:
  ├─ 恢復完成 → INIT
  └─ 恢復超時 (100ms) → SAFE_STATE
```

**驗收標準**:
1. 狀態轉遷覆蓋率 100% (所有有效路徑)
2. 故障聚合邏輯正確性 (3! = 6 個故障組合測試)
3. 無無效轉遷
4. 無死鎖狀態

**驗證方法**: 測試 (狀態機測試, 故障注入)

---

## 6. 驗證需求 - 基於 Q3 澄清決策

### 覆蓋率目標 (ASIL-B 標準)

| 指標 | 目標 | 說明 |
|------|------|------|
| 語句覆蓋率 (SC) | = 100% | 所有可執行語句 |
| 分支覆蓋率 (BC) | = 100% | 所有 if/else/switch 分支 |
| 診斷覆蓋率 (DC) | > 90% | 軟體故障檢測能力 |
| 複雜度 (CC) | ≤ 15 | 每個函式最大複雜度 |

### 測試方法

**硬體驗證 (UVM)**:
- 邊界值測試: VDD = 2.65V, 2.70V, 2.75V
- 時序測試: 檢測延遲驗證
- 故障注入: 各故障模式組合
- 覆蓋率: 語句 ≥ 95%, 分支 ≥ 95%

**軟體驗證 (pytest)**:
- 單元測試: 每個函式的邏輯驗證
- 整合測試: ISR + 狀態機協同
- 故障注入: 手動設置 fault_flags
- 覆蓋率: SC = 100%, BC = 100%

---

## 7. ASIL 降級論證 - 基於 Q4 決策

### ASIL-B 降級到 ASIL-A 的條件

**前提**: 根據 ISO 26262-3 Part 8，若硬體和軟體故障為獨立故障源，可適用獨立故障假設進行降級。

**硬體側分析**:
- 故障來源: 類比監控電路 (VDD、時鐘、記憶體 ECC)
- 故障模式: 比較器失效、RC 漂移、傳感器故障
- 故障檢測: 硬體自動進入安全狀態 (無軟體依賴)
- 故障率: λ_HW ≈ 100 FIT (估計值)

**軟體側分析**:
- 故障來源: 數位邏輯 (ISR、狀態機、恢復邏輯)
- 故障模式: 編碼錯誤、邏輯錯誤、時序錯誤
- 故障檢測: 軟體檢測和上報 (依賴硬體正常工作)
- 故障率: λ_SW ≈ 50 FIT (估計值)

**獨立性驗證**:
```
硬體故障 ≠ 軟體故障 (無共同根本原因)
↓
雙故障概率 = λ_HW × λ_SW / (λ_HW + λ_SW + mutual_term) ≈ 0
↓
系統可降級為 ASIL-A (前提: DC > 90%)
```

**降級條件**:
1. [x] 獨立故障源驗證: 硬體 (類比) ≠ 軟體 (數位)
2. [x] 硬體診斷覆蓋率: > 90% (通過 FMEA 分析)
3. [x] 故障率計算: ASIL-A 可達成
4. [ ] 獨立評審: 由安全專家簽核

---

## 8. 追蹤矩陣

### SG → FSR 映射

| SG | FSR | 內容 |
|----|-----|------|
| SG-001 | FSR-001 | VDD 低壓檢測 |
| SG-002 | FSR-002 | 時鐘丟失檢測 |
| SG-003 | FSR-003 | 記憶體 ECC |
| 所有 | FSR-004 | 故障狀態管理 |

### FSR → SysReq 映射

| FSR | SysReq | 內容 |
|-----|--------|------|
| FSR-001, 002, 003 | SysReq-001 | HW/SW 分配 |
| 所有 | SysReq-002 | 故障源獨立 |

### FSR → TSR 映射

| FSR | TSR | 內容 |
|-----|-----|------|
| FSR-001 | TSR-001 | VDD 硬體監控 |
| FSR-001, 002 | TSR-002 | ISR 故障檢測 |
| FSR-004 | TSR-003 | 故障聚合狀態機 |

---

## 9. 簽核

| 角色 | 簽名 | 日期 |
|------|------|------|
| 需求工程師 (Author) | _________ | _____ |
| 系統工程師 | _________ | _____ |
| 安全經理 | _________ | _____ |
| 項目經理 | _________ | _____ |

---

**End of Functional Specification Document**
