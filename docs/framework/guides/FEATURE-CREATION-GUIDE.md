# 特性建立指南

**目的**：遵循 ISO 26262 + ASPICE 框架建立新特性的逐步說明  
**對象**：系統架構師、需求工程師、硬體/軟體主管  
**版本**：1.0.0

---

## 快速開始 (5 分鐘)

```powershell
# 1. 建立新的特性目錄
PS> cd .specify/scripts
PS> .\create-feature.ps1 -Name "電源喪失保護" -ASIL "B" -Type "System"

# 輸出：
# 特性已建立：001-power-loss-protection
# ✓ 已建立目錄結構
# ✓ 所有範本已填充
# ✓ 特性 ID：001
# ✓ 可追蹤性矩陣已初始化
```

**下一步**：閱讀下面的"詳細逐步介紹"部分，了解完整說明。

---

## 詳細逐步介紹

### 第 1 階段：特性初始化 (第 1 天)

#### 步驟 1：識別特性範圍

回答這些問題：

**此特性要解決什麼安全危害？**
- 範例："寫入操作期間的電源喪失可能導致資料損壞"

**ASIL 等級是什麼？** (A=最低，D=最高)
- 使用 HARA (危害分析和風險評估) 輸出
- SSD 控制特性通常為 ASIL-B/C
- 安全關鍵特性 (資料完整性) → 最少 ASIL-B

**此特性屬於什麼組件？**
- 系統：多組件互動
- 硬體：電路、感測器、控制器元件
- 韌體：演算法、資料結構、狀態機

**誰是利害關係人？**
- 技術主管、安全經理、測試工程師、客戶代表

#### 步驟 2：生成特性結構

**使用指令碼** (建議)：

```powershell
.\create-feature.ps1 `
  -Name "電源喪失保護" `
  -ASIL "B" `
  -Type "System" `
  -Owner "John Smith" `
  -Stakeholders "Jane Lead, Bob Safety, Alice Test"
```

**手動方法** (如果指令碼不可用)：

1. 建立目錄：`specs/001-power-loss-protection/`
2. 從 `docs/framework/templates/` 將範本複製到特性目錄
3. 建立子目錄：`review-records/`
4. 使用特性元資料初始化所有範本檔案

#### 步驟 3：建立特性概述

編輯 `specs/001-power-loss-protection/spec.md`：

```markdown
# 特性 001：電源喪失保護

**ASIL**：B  
**類型**：系統 (硬體 + 韌體)  
**所有者**：John Smith  
**建立日期**：2025-12-16  
**狀態**：計畫中

## 執行摘要

系統必須在 NAND 寫入操作期間檢測電源喪失，並安全地中止寫入以防止資料損壞。檢測後，韌體必須檢查點目前狀態並通知主機操作失敗。

## 危害參考

來自 HARA 分析：
- **危害 H-3.2**：閃存寫入期間的電源喪失 → 損壞的資料塊
- **嚴重性**：S3 (可能遺失資料)
- **曝光度**：E3 (駕駛條件)
- **可控性**：C2 (駕駛員可以透過乾淨關機來減輕)
- **ASIL**：B (根據 ISO 26262-3:2018)

## 業務驅動因素

- 支援 PCIe 規格 (草案版本 5.1)
- 對抗客戶投訴 (有 3 個已報告的資料損壞事件)
- 符合 ISO 26262 功能安全要求

---

### 第 2 階段：需求分析 (第 2-3 天)

#### 步驟 4：建立安全目標 (SG)

從危害開始並定義安全目標：

```markdown
# SG-001-01：防止寫入期間的資料損壞

**ASIL**：B  
**衍生自**：危害 H-3.2  
**目標**：系統必須檢測電源喪失並中止寫入操作

**可測量的成功標準**：
- 100% 的寫入操作要麼成功要麼被中止(不能損壞)
- 檢測延遲 < 1ms
- 無虛假失效檢測 (PPM < 10)

**生命週期**：
- 狀態：已認可
- 簽署者：安全經理
- 日期：2025-12-16
```

#### 步驟 5：衍生功能安全需求 (FSR)

對於每個 SG，建立一個或多個 FSR：

```markdown
# FSR-001-01：檢測電源喪失

**ASIL**：B (繼承自 SG-001-01)  
**衍生自**：SG-001-01  
**類型**：檢測  
**優先級**：高

**要求**：系統必須在電源下降到操作臨界值以下 1ms 內檢測。

**功能描述**：
1. 硬體檢測電源軌下降
2. 向韌體發出中斷信號
3. 韌體停止任何正在進行的寫入操作
4. 向主機報告失敗狀態

**驗收標準**：
- [ ] 檢測延遲 < 1ms
- [ ] 檢測精度 ± 100mV
- [ ] 恢復時間 < 100ns
- [ ] FMEA 風險優先數 < 150

**驗證方法**：
- 測試 (實驗室功率掃描)
- 分析 (時序驗證)
- 檢查 (代碼審查)

**生命週期**：
- 狀態：已審查
- 簽署者：技術主管
- 日期：2025-12-16

---

# FSR-001-02：安全中止寫入

**ASIL**：B (繼承自 SG-001-01)  
**衍生自**：SG-001-01  
**類型**：減輕  
**優先級**：高

**要求**：檢測到電源喪失後，韌體必須立即停止任何正在進行的寫入操作。

**功能描述**：
1. 接收來自硬體檢測器的中斷
2. 清除 NAND 命令隊列
3. 停用寫入時鐘
4. 保存恢復狀態

**驗收標準**：
- [ ] 中止延遲 < 10µs
- [ ] 未傳輸的資料已放棄
- [ ] 狀態標誌已設定供恢復使用

**驗證方法**：
- 測試 (中止延遲測量)
- 分析 (代碼路徑分析)

**生命週期**：
- 狀態：已審查
- 簽署者：軟體主管
- 日期：2025-12-16
```

#### 步驟 6：開發系統需求 (SYS-REQ)

分解每個 FSR 為系統需求：

```markdown
# SYS-REQ-001-01：電源檢測電路

**ASIL**：B (繼承自 FSR-001-01)  
**衍生自**：FSR-001-01  
**組件**：電源監視器 (硬體)  
**優先級**：高

**要求**：

在供應電壓跌至 2.8V 以下時，硬體必須立即 (< 1ms) 將電源喪失信號驅動至低電平，以觸發韌體中斷。

**詳細設計限制**：
- 檢測閾值：2.8V ± 100mV
- 輸出跳變時間：< 100ns
- 誤差率：PPM < 10 (百萬分之)

**驗收標準**：
- [ ] 檢測延遲測量 < 1ms (溫度、電壓角超過)
- [ ] 輸出在 < 100ns 內改變
- [ ] 無抖動 (閾值 ± 50mV 範圍外無中斷)

**驗證方法**：
- 測試 (功率掃描、溫度掃描、噪聲注入)
- 分析 (電路時序模擬)

**設計參考**：
- 電源監視器 IC：[型號 XYZ123]
- 參考設計：`docs/hardware/power-monitor-ref-design.md`

**生命週期**：
- 狀態：已審查
- 簽署者：硬體主管
- 日期：2025-12-16

---

# SYS-REQ-001-02：寫入中止邏輯

**ASIL**：B (繼承自 FSR-001-02)  
**衍生自**：FSR-001-02  
**組件**：韌體寫入控制器  
**優先級**：高

**要求**：

從硬體接收電源喪失中斷時，韌體必須在 < 10µs 內完全停止任何正在進行的 NAND 寫入操作。

**詳細規格**：
- 中止延遲：< 10µs (從中斷線上升邊緣測量)
- NAND 命令隊列：已清除
- 寫入時鐘：已停用
- 狀態暫存器：已設定 "power-loss-detected" 位

**驗收標準**：
- [ ] 檢測中斷並設定中止標記 < 2µs
- [ ] 命令隊列已清除 < 5µs
- [ ] 寫入時鐘停用 < 1µs
- [ ] 總中止時間 < 10µs

**驗證方法**：
- 測試 (中止延遲測量、邏輯分析儀)
- 分析 (代碼路徑時序分析)
- 檢查 (代碼審查 - 無 sleep/loop 在關鍵路徑上)

**實施參考**：
- 中斷處理程式：`src/firmware/power-loss-interrupt.c`
- 寫入控制器：`src/firmware/nand-write-controller.c`

**生命週期**：
- 狀態：已審查
- 簽署者：韌體主管
- 日期：2025-12-16
```

#### 步驟 7：配置技術安全需求 (TSR)

為每個 SYS-REQ 分配硬體或軟體 TSR：

```markdown
# TSR-HW-001-01：電源監視器電路

**ASIL**：B  
**衍生自**：SYS-REQ-001-01  
**類型**：硬體模組  
**責任**：設計和驗證電源監視器電路

**關鍵職責**：
1. 實施電源檢測邏輯
2. 達成 < 1ms 檢測延遲
3. 達成 PPM < 10 誤差率

**設計考慮**：
- 溫度補償
- 電源雜訊濾波
- 冷啟動行為
- 故障模式冗餘度

**驗證職責**：
- 單元測試 (UVM 模擬)
- 集成測試 (硬體-在環)
- 系統測試 (電源衝擊驗證)

---

# TSR-SW-001-01：電源喪失中斷處理程式

**ASIL**：B  
**衍生自**：SYS-REQ-001-02  
**類型**：軟體模組  
**責任**：實施中斷處理和寫入中止

**關鍵職責**：
1. 接收電源喪失中斷
2. 停止任何正在進行的寫入
3. 保存恢復狀態
4. 通知主機

**代碼組織**：
- 檔案：`src/firmware/power-loss-handler.c`
- 函式：`void powerLossInterruptHandler()`
- 限制：目前無 sleep/等待；WCET < 10µs

**驗證職責**：
- 單元測試 (中止時序)
- 集成測試 (寫入+中止場景)
- 系統測試 (電源故障恢復測試)

---

# TSR-SW-001-02：狀態恢復管理

**ASIL**：B  
**衍生自**：SYS-REQ-001-02  
**類型**：軟體模組  
**責任**：在電源恢復後管理狀態恢復

**關鍵職責**：
1. 檢查電源喪失標記
2. 查詢 NAND 狀態
3. 決定重試或放棄
4. 重新初始化寫入控制器

**代碼組織**：
- 檔案：`src/firmware/power-loss-recovery.c`
- 函式：`void handlePowerLossRecovery()`

**驗證職責**：
- 單元測試 (恢復邏輯)
- 集成測試 (各種故障情景)
- 系統測試 (完整的電源週期)
```

#### 步驟 8：建立可追蹤性矩陣

建立文檔 `specs/001-power-loss-protection/traceability.md`：

```markdown
# 可追蹤性矩陣 - 特性 001

## 正向可追蹤性 (需求 → 實施)

| 需求 ID | 需求 | 設計 | 代碼 | 測試 | 覆蓋率 |
|--------|------|------|------|------|---------|
| SG-001-01 | 防止資料損壞 | arch.md | - | TC-SYS-001 | ✓ |
| FSR-001-01 | 檢測電源喪失 | architecture.md | power-loss-detector.v | TC-HW-001 | ✓ |
| FSR-001-02 | 安全中止寫入 | detailed-design.md | power-loss-handler.c | TC-SW-001 | ✓ |
| SYS-REQ-001-01 | 電源監視器電路 | hw-architecture.md | power_monitor.v | TC-HW-002 | ✓ |
| SYS-REQ-001-02 | 寫入中止邏輯 | fw-architecture.md | power_loss_handler.c | TC-SW-002 | ✓ |

## 反向可追蹤性 (實施 → 需求)

所有代碼行都應標記為 `@requirement <REQ-ID>`

範例：
```c
// @requirement TSR-SW-001-01
// 檢測電源喪失中斷並停止寫入
void POWER_LOSS_ISR() {
    WRITE_CLOCK_DISABLE();  // @requirement TSR-SW-001-01
    CMD_QUEUE_CLEAR();      // @requirement TSR-SW-001-01
    STATUS_SET_POWER_LOSS_FLAG();  // @requirement TSR-SW-001-02
}
```

## 覆蓋率摘要

- 需求涵蓋率：100% (8 個需求有設計/代碼/測試)
- 代碼涵蓋率：100% (所有行都有 @requirement 標籤)
- 測試涵蓋率：100% (所有需求都有測試用例)

**狀態**：✓ 完整且經過驗證
```

---

### 第 3 階段：架構與設計 (第 4-6 天)

#### 步驟 9：建立系統架構設計

建立 `specs/001-power-loss-protection/architecture.md`：

```markdown
# 系統架構 - 特性 001：電源喪失保護

## 功能塊圖

```
    ┌─────────────────────────────────────────────┐
    │        主機介面 (PCIe/SATA)                 │
    └────────────┬────────────────────────────────┘
                 │
    ┌────────────▼────────────────────────────────┐
    │      SSD 控制器韌體                         │
    │  ┌──────────────────────────────────────┐   │
    │  │  電源喪失中止邏輯                    │   │
    │  │  - 中止寫入操作                      │   │
    │  │  - 保存狀態                          │   │
    │  └──────────────────────────────────────┘   │
    └────────────┬────────────────────────────────┘
                 │
    ┌────────────▼────────────────────────────────┐
    │      NAND 寫入控制器                        │
    │  ┌──────────────────────────────────────┐   │
    │  │  寫入命令隊列                        │   │
    │  │  寫入計時和同步                      │   │
    │  └──────────────────────────────────────┘   │
    └────────────┬────────────────────────────────┘
                 │
    ┌────────────▼────────────────────────────────┐
    │      NAND 快閃記憶體                        │
    │  ┌──────────────────────────────────────┐   │
    │  │  多個 NAND 晶片                      │   │
    │  │  (平行傳輸通道)                      │   │
    │  └──────────────────────────────────────┘   │
    └─────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────┐
    │      電源管理 (1.2V / 3.3V / 5V)           │
    │  ┌──────────────────────────────────────┐   │
    │  │  電源監視器 IC                        │   │
    │  │  - 監視 1.2V 軌                       │   │
    │  │  - 檢測 < 2.8V 條件                   │   │
    │  │  - 驅動中斷信號                      │   │
    │  └──────────────────────────────────────┘   │
    └────────────┬────────────────────────────────┘
                 │
    ┌────────────▼────────────────────────────────┐
    │      中斷控制器                            │
    │  ┌──────────────────────────────────────┐   │
    │  │  路由電源喪失中斷                    │   │
    │  │  到韌體                              │   │
    │  └──────────────────────────────────────┘   │
    └─────────────────────────────────────────────┘
```

## 信號介面

```markdown
### 電源監視器 → 韌體

| 信號 | 方向 | 描述 |
|------|------|------|
| PWR_LOSS_N | IN | 電源喪失中斷 (低有效) |
| PWR_MONITOR_RDY | OUT | 監視器準備好 |

### 韌體 → NAND 控制器

| 信號 | 方向 | 描述 |
|------|------|------|
| WRITE_ABORT | OUT | 中止現有寫入 |
| CMD_QUEUE_CLR | OUT | 清除命令隊列 |
```

## 時序分析

- 電源喪失檢測到韌體中斷：< 1ms
- 韌體中斷到 NAND 寫入停止：< 10µs
- 總端到端延遲：< 1.01ms
- 餘量：> 990µs 用於其他操作

---

### 第 4 階段：安全性分析 (第 7-8 天)

#### 步驟 10：進行 FMEA

建立 `specs/001-power-loss-protection/fmea.md`：

```markdown
# FMEA - 特性 001：電源喪失保護

| 失效模式 | 嚴重性 | 發生 | 檢測 | RPN | 減輕方案 |
|---------|--------|------|------|-----|----------|
| 電源監視器未檢測到喪失 | 10 | 8 | 4 | 320 | 冗餘監視器 + 測試 |
| 中斷延遲 > 1ms | 9 | 6 | 5 | 270 | 硬體時序設計 |
| 韌體未停止寫入 | 10 | 3 | 3 | 90 | 代碼審查 + 單元測試 |
| 恢復邏輯失敗 | 7 | 4 | 4 | 112 | 系統測試 |

**高風險項目** (RPN > 150)：
- 冗餘監視器
- 硬體時序驗證
- 集成測試
```

#### 步驟 11：進行 FTA

建立 `specs/001-power-loss-protection/fta.md`：

```markdown
# FTA - 特性 001

## 頂級事件：資料在寫入期間損壞

```
            ┌─ 檢測失敗
            │
頂級事件 ───┼─ 未能中止
            │
            └─ 恢復失敗
```

**最小割集**：
1. {電源監視器失效} - RPN: 320
2. {中斷延遲過長} - RPN: 270
```

---

### 第 5 階段：實施與驗證 (第 9-15 天)

#### 步驟 12：編寫硬體代碼 (Verilog)

建立 `src/hardware/power_loss_detector.v`：

```verilog
// @requirement TSR-HW-001-01
// 電源喪失檢測器 - 監視 1.2V 軌，檢測 < 2.8V

module power_loss_detector (
  input  wire clk,
  input  wire reset_n,
  input  wire [11:0] voltage_adc,  // 從 ADC 取樣電壓
  output reg pwr_loss_n  // 中斷輸出 (低有效)
);

parameter THRESHOLD = 12'h700;  // 2.8V (12 位 ADC 中 ~1792)

always @(posedge clk or negedge reset_n)
  if (!reset_n)
    pwr_loss_n <= 1'b1;
  else if (voltage_adc < THRESHOLD)
    pwr_loss_n <= 1'b0;  // @requirement TSR-HW-001-01
  else
    pwr_loss_n <= 1'b1;

endmodule
```

#### 步驟 13：編寫韌體代碼 (C)

建立 `src/firmware/power_loss_handler.c`：

```c
// @requirement TSR-SW-001-01
// 電源喪失中斷處理程式

#include "nand_controller.h"
#include "power_manager.h"

volatile uint8_t power_loss_detected = 0;

// @requirement TSR-SW-001-01
void POWER_LOSS_ISR(void) {
  // 禁用寫入時鐘
  WRITE_CLOCK_DISABLE();  // @requirement TSR-SW-001-01
  
  // 清除命令隊列
  CMD_QUEUE_CLEAR();  // @requirement TSR-SW-001-01
  
  // 設定狀態標記
  power_loss_detected = 1;  // @requirement TSR-SW-001-02
}

// @requirement TSR-SW-001-02
void handle_power_loss_recovery(void) {
  if (power_loss_detected) {
    // 查詢 NAND 狀態
    uint8_t nand_status = NAND_READ_STATUS();
    
    // 重新初始化控制器
    NAND_SOFT_RESET();
    
    // 報告給主機
    notify_host_power_loss();
  }
}
```

#### 步驟 14：編寫測試用例

建立 `src/test/test_power_loss.py`：

```python
# @requirement TC-HW-001, TC-SW-001
import pytest
from power_loss_simulator import PowerLossSimulator

class TestPowerLossProtection:
    
    # @requirement TC-HW-001
    def test_power_loss_detection(self):
        """驗證電源喪失在 < 1ms 內被檢測"""
        sim = PowerLossSimulator()
        
        # 將電壓降至 2.8V
        sim.set_voltage(2.8)
        
        # 測量檢測延遲
        detection_time = sim.measure_interrupt_latency()
        
        assert detection_time < 1.0, "檢測延遲超出規格"
        assert sim.interrupt_triggered, "中斷未觸發"
    
    # @requirement TC-SW-001
    def test_write_abort(self):
        """驗證寫入在檢測到電源喪失後被中止"""
        sim = PowerLossSimulator()
        
        # 啟動寫入操作
        sim.start_nand_write(data=b'\xFF' * 4096)
        
        # 模擬電源喪失
        sim.trigger_power_loss()
        
        # 驗證寫入已停止
        abort_time = sim.measure_write_abort_time()
        assert abort_time < 10.0, "寫入中止延遲超出規格"
        assert sim.nand_write_completed == False, "寫入未中止"
```

---

### 第 6 階段：審查與批准 (第 16-17 天)

#### 步驟 15：進行設計審查

組織會議討論：
- 架構設計
- FMEA 結果
- 測試計畫

簽署： `review-records/design-review-signed.md`

#### 步驟 16：進行代碼審查

- 檢查編碼標準 (MISRA C)
- 驗證可追蹤性標籤
- 測量代碼涵蓋率 (目標：100%)

簽署： `review-records/code-review-signed.md`

#### 步驟 17：進行驗證審查

- 驗證所有測試通過
- 測試涵蓋率 = 100% (所有 SYS-REQ 都有測試)
- 無孤立代碼

簽署： `review-records/verification-review-signed.md`

---

### 第 7 階段：基線與發佈 (第 18 天)

#### 步驟 18：建立基線

```bash
# 在 Git 中標記特性版本
git tag -a "001-power-loss-protection-v1.0" \
  -m "Feature 001: Power Loss Protection - Released for product build v2.5"

# 推送到存儲庫
git push origin 001-power-loss-protection-v1.0
```

#### 步驟 19：建立發佈文檔

建立 `specs/001-power-loss-protection/RELEASE-NOTES.md`：

```markdown
# 發佈說明 - 特性 001：電源喪失保護

**版本**：1.0.0  
**發佈日期**：2025-12-24  
**狀態**：生產就緒

## 摘要

此特性實施了檢測和減輕 NAND 寫入期間電源喪失的能力。此功能對於防止資料損壞至關重要，並支援 SSD 韌體進行安全的電源序列化。

## 驗證結果

✓ 所有 8 個需求已實施和測試  
✓ 代碼涵蓋率：100%  
✓ FMEA 風險優先數 < 200  
✓ 檢測延遲 < 1ms  
✓ 所有設計/代碼/驗證審查已簽署

## 已知限制

無

## 後續步驟

- 將此特性整合到產品組建 v2.5
- 執行系統級驗收測試
- 發佈給客戶進行聯合驗收測試 (JAT)
```

---

## 檢查清單

按順序完成以下步驟：

- [ ] **第 1 階段**：特性初始化
  - [ ] 範圍已定義
  - [ ] ASIL 已確定
  - [ ] 目錄結構已建立
  - [ ] 特性概述已編寫

- [ ] **第 2 階段**：需求分析
  - [ ] SG 已定義 (安全目標)
  - [ ] FSR 已衍生 (功能安全需求)
  - [ ] SYS-REQ 已開發 (系統需求)
  - [ ] TSR 已配置 (技術安全需求)
  - [ ] 可追蹤性矩陣已初始化

- [ ] **第 3 階段**：架構與設計
  - [ ] 系統架構已記錄
  - [ ] 硬體架構已設計
  - [ ] 軟體架構已設計
  - [ ] 信號介面已定義
  - [ ] 時序分析已完成

- [ ] **第 4 階段**：安全性分析
  - [ ] FMEA 已完成
  - [ ] 高風險項目已識別
  - [ ] 減輕方案已提議
  - [ ] FTA 已完成
  - [ ] DFA 已完成

- [ ] **第 5 階段**：實施與驗證
  - [ ] 硬體代碼已實施
  - [ ] 軟體代碼已實施
  - [ ] 單元測試已執行
  - [ ] 代碼涵蓋率 = 100%
  - [ ] 集成測試已執行
  - [ ] 系統測試已執行
  - [ ] 可追蹤性已驗證

- [ ] **第 6 階段**：審查與批准
  - [ ] 設計審查已完成和簽署
  - [ ] 代碼審查已完成和簽署
  - [ ] 驗證審查已完成和簽署

- [ ] **第 7 階段**：基線與發佈
  - [ ] Git 標籤已建立
  - [ ] 發佈說明已編寫
  - [ ] 特性已存檔

---

## 有用的 PowerShell 命令

```powershell
# 驗證可追蹤性
.\check-traceability.ps1 -Feature "001-power-loss-protection" -Report

# 檢查需求涵蓋率
.\check-requirements-coverage.ps1 -Feature "001-power-loss-protection"

# 檢查變更影響
.\check-change-impact.ps1 -Feature "001-power-loss-protection" -File "requirements.md"

# 查看特性狀態
git log --oneline 001-power-loss-protection

# 查看所有特性
Get-ChildItem specs/ | Where-Object {$_.Name -match "^\d{3}-"}
```

---

## 常見問題

**Q：我不確定 ASIL 應該是什麼？**  
A：查閱 HARA 分析文檔或詢問安全經理。如有疑問，選擇更高的 ASIL 值(更嚴格)。

**Q：我可以跳過任何階段嗎？**  
A：否。每個階段都完成了前期階段相依的特定工作產品。跳過階段會留下追蹤間隙。

**Q：測試涵蓋率目標真的是 100% 嗎？**  
A：是的，針對 ASIL-B 及以上。任何無法測試的代碼必須進行正當理由說明並記錄。

**Q：是否有工具可以幫助我？**  
A：是的。查看 `.specify/scripts/` 中的自動化指令碼。

---

**文檔版本**：1.0.0  
**最後更新**：2025-12-02  
**下次審查**：2026-03-02
